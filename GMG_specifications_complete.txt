GESTION MAT√âRIEL ‚Äî SP√âCIFICATIONS TECHNIQUES & FONCTIONNELLES
Derni√®re mise √† jour: 2025-09-24T13:46:39Z


============================================================
1) OBJECTIF & P√âRIM√àTRE
------------------------------------------------------------
Suite applicative de gestion op√©rationnelle (levage, transport, manutention) couvrant:
- Planification des interventions
- Pr√©-devis et devis
- Facturation
- R√©f√©rentiels (Ressources / Types / Clients / Contacts)
- Multi-agences, mod√®les de documents (HTML->PDF), envoi email avec tracking
- S√©curit√© par r√¥les et session
- Mode Mock et mode API (compatibles et interchangeables)

Composants:
- FRONTEND: client Java/Swing
- BACKEND: Spring Boot (API REST), V1 legacy conserv√©e, V2 √©tendue
- Donn√©es de d√©monstration (mocks) riches et scalables

============================================================
2) UX GLOBALE & NAVIGATION
------------------------------------------------------------
- Barre lat√©rale (Sidebar) compacte/√©largie avec ic√¥nes + libell√©s; "pin" pour fixer.
- Survol = affiche libell√©s; compact = ic√¥nes seules.
- Masquage/activation dynamique des entr√©es selon r√¥le utilisateur.
- En-t√™te avec bouton D√©connexion et gestion d'expiration de session.
- √âcran d'accueil: s√©lection Agence, puis choix Backend (Mock/API), puis Login/MDP.
- √âcrans principaux:
  * Planning (√©cran pivot)
  * Liste (vision tabulaire des interventions ‚Äî optionnel selon build)
  * Pipeline (workflow interventions/devis/factures ‚Äî optionnel)
  * Ventes: Devis / Factures (tables + √©dition inline)
  * Param√®tres (G√©n√©ral, Templates, Assets, Types d‚Äôintervention, Types de ressources, Utilisateurs/Comptes)
  * R√©f√©rentiels: Ressources, Clients/Contacts
- Suppression des onglets "Calendrier" et "Cartes" ind√©pendants: la vue Planning unique int√®gre les fonctionnalit√©s.

============================================================
3) PLANNING ‚Äî COMPORTEMENTS & INTERACTIONS
------------------------------------------------------------
3.1 Surface de planification
- Tuiles Intervention avec rendu moderne (coins arrondis, d√©grad√© l√©ger, bord color√© selon statut).
- Zoom vertical via Ctrl+molette (bornes ~0.5..6.0 min/px).
- Scroll vertical fluide (surface scrollable = grille r√©elle).
- Surlignage de la ligne ressource sous la souris (hover).

3.2 Drag & Drop + Resize (pixel parfait)
- D√©placement vertical (heure) et horizontal (jour).
- Drop sur une autre ligne ressource = r√©affectation.
- Redimensionnement par bords haut/bas (curseurs N/S resize).
- Accrochage (snap) √† un pas configurable (par d√©faut 30 min) + guide visuel.
- Tooltip live pendant drag/resize: HH:mm‚ÄìHH:mm + ressource cible.
- Save() sur drop + reload() du planning.
- Gestion multi-ressources: la ressource √† l‚Äôindex 0 est l‚Äôaffectation principale (remplac√©e au drop); les autres sont conserv√©es.

3.3 Filtres & tri (barre sup√©rieure)
- Filtre statut (Brouillon, Planifi√©, En cours, Termin√©, Annul√©/Probl√®me).
- Filtre ‚Äú√Ä deviser / D√©j√† devis√©‚Äù (marqueur bool√©en intervention.devisGenere).
- Filtre par Type de ressource, par Agence.
- Mode compacte vs confortable (densit√©).
- Recherche globale (ic√¥nes color√©es int√©gr√©es).

3.4 √âdition rapide
- Double-clic ouvre la fiche Intervention.
- Menu contextuel (clic droit) sur la grille: ouvrir, √©diter, marquer termin√© (selon r√¥le), g√©n√©rer devis.
- Palette contextuelle (si activ√©e): ‚ÄúG√©n√©rer devis pour N interventions s√©lectionn√©es‚Äù, rappel des filtres actifs, aide avec raccourcis.

============================================================
4) INTERVENTION ‚Äî MOD√àLE & DIALOGUE D‚Äô√âDITION
------------------------------------------------------------
4.1 Donn√©es principales
- Titre / Label (+ r√©f√©rence interne √©ventuelle)
- Client (s√©lecteur) + Contacts (multi, avec Contact principal auto-coch√© si d√©fini)
- Type d‚Äôintervention (param√©trable; ordre, duplication)
- Adresse/chantier (texte libre ou r√©f√©rentiel; pr√©vu pour g√©ocodage futur)
- Date/heure de d√©but/fin pr√©vues (plannedStart/plannedEnd) + effectives (r√©el)
- Description (publique / visible) + Note interne + Note de fin
- Statut (brouillon, planifi√©, en cours, termin√©, annul√©)
- Ressources (liste h√©t√©rog√®ne): chaque ressource r√©f√©rence son type (ic√¥ne SVG) et son PU
- Signature client (PNG), ‚Äúsign√© par‚Äù + date/heure
- Marqueur ‚Äúdevis g√©n√©r√©‚Äù (bool)

4.2 Pr√©-devis int√©gr√©
- G√©n√©ration automatique des lignes depuis les ressources s√©lectionn√©es (PU pris sur la Ressource, pas sur le Type).
- Table ‚Äúfacturation‚Äù dans la fiche: colonnes d√©signation, quantit√©, PU HT, total HT/ttc (selon param√®tres TVA).
- Bouton ‚ÄúG√©n√©rer le devis‚Äù (endpoint V2).
- Apr√®s cr√©ation: affichage de la r√©f√©rence du devis li√© + verrouillage des r√©g√©n√©rations (idempotence soft).

4.3 Ergonomie
- Onglets: G√©n√©ral (titre/client/dates/description/note interne), Intervention (ressources, notes fin, signature), Facturation (pr√©-devis).
- Mode plein √©cran pour les dispatchers + taille ajustable.
- Filtre local des ressources par Type + recherche texte + colonnes avec PU HT visibles.
- Ajout/suppression par cases √† cocher; liste de s√©lection vs disponibles.
- G√©n√©ration de devis en lot depuis le planning: si devis existe d√©j√† pour l'intervention, on ne reg√©n√®re pas.

============================================================
5) RESSOURCES & TYPES
------------------------------------------------------------
5.1 Types de ressources
- R√©f√©rentiel param√©trable (cr√©ation/√©dition/suppression).
- Ic√¥ne SVG color√©e affect√©e au Type (affich√©e dans la tuile, la recherche globale, les toasts, les listes).
- Tri/ordre configurable.

5.2 Ressources
- √âcran de gestion dans le panneau (comme Clients): √©dition inline, pas de modales.
- Champs: id, nom, type (combo), PU (tarif), indisponibilit√©s (p√©riodes d√©but/fin).
- Filtre par Type + tri par Type par d√©faut.
- Ic√¥ne h√©rit√©e du Type (affichage dans listes/planning).
- Indisponibilit√©s: structure {{dateDebut, dateFin}} (liste), UI avec datepickers.

============================================================
6) CLIENTS & CONTACTS
------------------------------------------------------------
- Clients: r√©f√©rentiel avec filtres; √©dition dans le panneau.
- Contacts: 2‚Äì4 contacts par client (mock boost√©), champ ‚Äúcontact principal‚Äù.
- S√©lection dans Intervention: multi-contacts; ‚Äúprincipal‚Äù coch√© d‚Äôoffice si existant.
- Recherche globale unifi√©e (ic√¥nes int√©gr√©es).

============================================================
7) VENTES ‚Äî DEVIS & FACTURES
------------------------------------------------------------
7.1 Devis
- Tables avec recherche/tri, √©dition inline des lignes / totaux, export PDF (HTML->PDF), export CSV/Excel.
- G√©n√©ration depuis Intervention (endpoint /api/v2/quotes/from-intervention).
- Conversion Devis -> Facture (unitaire ou multiple).
- Envoi PDF par email (group√©, CC/BCC, mod√®les par agence).

7.2 Factures
- Tables analogues (recherche/tri, inline).
- G√©n√©ration depuis Devis (s√©lection multiple possible).
- Export PDF/CSV/Excel, email avec pi√®ces jointes.

============================================================
8) EMAILS & TRACKING
------------------------------------------------------------
- Emails HTML avec mod√®le par Agence (variables de fusion).
- Pi√®ces jointes PDF (devis/factures d√©taill√©s).
- Envoi group√© (plusieurs destinataires; CC/BCC).
- Tracking d‚Äôouverture via pixel (v12.2).
- Mod√®les: gestion dans Param√®tres -> Templates (partiels support√©s).

============================================================
9) G√âN√âRATION DOCUMENTS (HTML ‚Üí PDF)
------------------------------------------------------------
- √âditeur de templates avec pr√©visualisation PDF live.
- Partials ({{>partial:nom}}) et assets ({{asset:cl√©}}).
- Fallback CGV: si partial ‚Äúcgv‚Äù absent, insertion des CGV Agence.
- Gabarits QUOTE/INVOICE/EMAIL/PARTIAL par agence.
- Onglet ‚ÄúAssets‚Äù: upload/logos/tampons (PNG/JPG/SVG), cl√©s utilisables dans templates.

============================================================
10) PARAM√àTRES & AGENCES
------------------------------------------------------------
- S√©lection agence au login.
- X-Agency-Id obligatoire sur tous les clients HTTP (interventions/resources/clients/devis/factures).
- Param√®tres -> G√©n√©ral:
  * TVA (%) par Agence
  * CGV (HTML) par Agence (√©diteur + preview PDF)
  * Intervalle d‚Äôautosave des fiches (15/30/60 s)
- Param√®tres -> Templates & Assets (par Agence)
- Param√®tres -> Types d‚Äôintervention (ordre/duplication)
- Param√®tres -> Types de ressources
- Param√®tres -> Comptes/Utilisateurs (cr√©ation, r√¥les, reset MDP; changement de MDP utilisateur)
- Masquage des entr√©es du menu selon r√¥le.

============================================================
11) S√âCURIT√â & R√îLES
------------------------------------------------------------
R√¥les principaux:
- ADMIN: tous les droits.
- SALES: lecture Planning, droits complets sur Devis/BC/BL/Factures; pas de configuration sensible.
- CONFIGURATEUR: lecture globale, √©criture limit√©e aux ressources/types/param√®tres.
M√©caniques:
- Masquage/disable UI selon r√¥le (menu + dialogs).
- Lecture-seule forc√©e dans les dialogs de ventes si r√¥le insuffisant.
- Expiration de session (inactivit√©), bouton D√©connexion header.
- Migration future possible vers JWT c√¥t√© API (pr√©par√©e).

============================================================
12) API ‚Äî CONTRATS & EXTENSIONS
------------------------------------------------------------
V1 (legacy):
- Endpoints existants conserv√©s; sch√©mas historiques (number, lines, totalHT, totalTtc, etc.).
- Compatibilit√© maintenue (pas de cassure).

V2 (nouvelles routes/DTOs):
- POST /api/v2/quotes/from-intervention
  * Entr√©e: interventionId (+ agency header).
  * Sortie: quoteRef / id (et liaison stock√©e c√¥t√© intervention).
- GET/PUT /api/v2/settings (par Agence)
  * TVA, CGV HTML, email models/partials optionnels.
- Email send endpoints (HTML + tracking).
- Alignement JSON: respecter camelCase `totalTtc` (Jackson @JsonProperty si besoin).

Ent√™tes:
- X-Agency-Id: obligatoire sur interventions/resources/clients/devis/factures.

Gateways c√¥t√© client (ServiceLocator):
- interventions(): list(filter), get(id), save(item), delete(id)
- resources(): listAll(), get(id), save(item), delete(id)
- clients(): listAll(), get(id), save(item), delete(id)
- quotesV2(): fromIntervention(interventionId) ‚Ä¶
- invoices(): ‚Ä¶
(les m√©thodes get(...) ont √©t√© ajout√©es quand n√©cessaire pour la r√©solution d‚Äôemail/ressource).

============================================================
13) MOCKS & DONN√âES DE D√âMO
------------------------------------------------------------
- ~60 ressources (grues, camions, chariots, techniciens‚Ä¶) avec ic√¥nes et PU vari√©s.
- Indisponibilit√©s renseign√©es sur plusieurs ressources.
- ~60 interventions r√©parties sur 2 semaines (types vari√©s, statuts mix√©s).
- ~20 clients √ó 2‚Äì4 contacts chacun; contact principal par client.
- ~15 utilisateurs couvrant les r√¥les ADMIN/SALES/CONFIGURATEUR.
- Ic√¥nes SVG color√©es disponibles via un registre commun (recherche/notifications/planning).

============================================================
14) RACCOURCIS & INTERACTIONS
------------------------------------------------------------
- Ctrl + molette: zoom vertical.
- Drag tile: d√©placer (heure/jour) ‚Äî drop sur ligne = changer la ressource principale.
- Resize bords: ajuster dur√©e.
- Tooltip live: HH:mm‚ÄìHH:mm + ressource.
- Palette (si activ√©e): actions contextuelles ("G√©n√©rer devis pour N interventions s√©lectionn√©es", etc.).

============================================================
15) TECHNIQUE ‚Äî CLIENT
------------------------------------------------------------
- Java 17+, Swing.
- Grille Planning: gestion interne des colonnes/jours et lignes ressources; APIs optionally expos√©es:
  * rowAtPoint(Point), rowBounds(int) ou getRowHeight()+getResources()
  * resourceAt(Point) et/ou getResourceAtRow(int)
- Rendu tuiles: JComponent translucide, d√©grad√©, antialiasing.
- Listeners directs sur la grille (pas d‚Äôoverlay), gestion du ghost dans paintComponent.
- Autosave param√©trable (sur formulaires d‚Äô√©dition).
- PDF Preview via PDFBox c√¥t√© client (pour certaines previews).

============================================================
16) TECHNIQUE ‚Äî SERVEUR
------------------------------------------------------------
- Spring Boot, Java.
- OpenAPI: V1 conserv√©; V2 ajout√© explicitement, sans casser V1.
- Controllers V2 pour: settings (TVA/CGV), quote-from-intervention, email send, assets/templates gestion.
- Respect du header X-Agency-Id avec propagation au service.
- DTOs V2 align√©s sur le camelCase attendu c√¥t√© client (ex: totalTtc).
- Signature PNG persist√©e (base64/byte[]), champs sign√©Par + sign√©Le.

============================================================
17) ERGONOMIE ‚Äî IC√îNES & VISUELS
------------------------------------------------------------
- Registre d‚Äôic√¥nes SVG color√©es (types de ressources, recherche, toasts, tuiles).
- Statuts par couleur: üü¢ Termin√©, üîµ Planifi√©/En cours, üü° Brouillon, üî¥ Annul√©/Probl√®me.
- Alerte pastille rouge ‚Äú!‚Äù si retard/mat√©riel manquant (logique de d√©tection configurable).

============================================================
18) NETTOYAGE & CODE MORT
------------------------------------------------------------
- Suppression des onglets "Calendrier" / "Cartes" et de leurs vues d√©di√©es si non r√©f√©renc√©es.
- Remplacement des anciennes tuiles par celles int√©gr√©es au Planning.
- Script propos√© (ripgrep + jdeps) pour identifier les classes non r√©f√©renc√©es.
- Recommandation: activer inspections ‚ÄúUnused declaration‚Äù dans l‚ÄôIDE et plugin maven-dependency:analyze-only.

============================================================
19) POINTS D‚ÄôATTENTION & QUALIT√â
------------------------------------------------------------
- Coh√©rence accessors mod√®le vs utilisation UI (ex: getDateHeureDebut vs getPlannedStart) ‚Äî conversions g√©r√©es.
- Casing JSON stable (totalTtc) ‚Äî annotations @JsonProperty si m√©thode Java diff√®re.
- ServiceLocator: exposer get(id) l√† o√π n√©cessaire (ResourcesGateway) pour √©viter compile blockers.
- Reload() : injecte r√©ellement les donn√©es dans la grille/table (et pas uniquement dans un cache).
- Tests manuels conseill√©s: 5 sc√©narios cl√©s (drag-ressource, resize, g√©n√©rer devis, envoi email, export PDF/CSV).

============================================================
20) ROADMAP COURTE
------------------------------------------------------------
- Param√©trage UI du pas de snap (15/30/60) par Agence.
- Tooltip drag avec dur√©e totale/√©carts (retard).
- Import CSV ressources/clients.
- Auth JWT c√¥t√© API si durcissement requis.
- G√©ocodage adresse chantier + estimation trajets/temps.
